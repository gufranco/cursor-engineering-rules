---
description: REST API conventions
globs: "**/routes/**,**/controllers/**,**/api/**"
alwaysApply: false
---

# API Design

## REST Conventions
- Resources: nouns, plural (`/users`, `/orders`)
- Nesting: max 2 levels (`/users/:id/orders`)
- Actions: POST when CRUD doesn't fit (`/orders/:id/cancel`)

## HTTP Methods
| Method | Purpose | Idempotent |
|--------|---------|------------|
| GET | Read | ✅ |
| POST | Create | ❌ |
| PUT | Replace | ✅ |
| PATCH | Update | ❌ |
| DELETE | Remove | ✅ |

## Status Codes
| Code | When |
|------|------|
| 200 | Success (GET, PUT, PATCH) |
| 201 | Created (POST) |
| 204 | Deleted |
| 400 | Malformed request |
| 401 | Not authenticated |
| 403 | Not authorized |
| 404 | Not found |
| 422 | Validation failed |
| 429 | Rate limited |

## Response Format
```json
{ "data": {}, "meta": { "requestId": "uuid" } }
{ "error": { "code": "ERROR_CODE", "message": "...", "requestId": "uuid" } }
```

## Webhook Endpoints

### Receiving Webhooks

#### Security
- Validate signature (HMAC-SHA256)
- Verify timestamp (reject if > 5 minutes old)
- Use idempotency key (event ID)

```typescript
function verifyWebhookSignature(
  payload: string,
  signature: string,
  secret: string
): boolean {
  const expected = crypto
    .createHmac('sha256', secret)
    .update(payload)
    .digest('hex');
  
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expected)
  );
}
```

#### Processing Pattern
```typescript
// ✅ Acknowledge immediately, process async
app.post('/webhooks/stripe', async (req, res) => {
  // 1. Verify signature
  if (!verifySignature(req)) {
    return res.status(401).json({ error: 'Invalid signature' });
  }
  
  // 2. Check idempotency
  const eventId = req.body.id;
  if (await isProcessed(eventId)) {
    return res.status(200).json({ received: true });
  }
  
  // 3. Queue for processing
  await queue.add('process-webhook', req.body);
  
  // 4. Acknowledge immediately
  res.status(200).json({ received: true });
});
```

#### Response Codes
| Code | Meaning | Sender Action |
|------|---------|---------------|
| 200 | Processed/Queued | Success |
| 400 | Invalid payload | Don't retry |
| 401 | Invalid signature | Don't retry |
| 429 | Rate limited | Retry with backoff |
| 500 | Server error | Retry with backoff |

### Sending Webhooks

#### Delivery Guarantees
- At-least-once delivery
- Exponential backoff on failure
- Dead letter queue after max retries

#### Retry Schedule
| Attempt | Delay |
|---------|-------|
| 1 | Immediate |
| 2 | 1 minute |
| 3 | 5 minutes |
| 4 | 30 minutes |
| 5 | 2 hours |
| 6+ | Dead letter |

#### Payload Structure
```json
{
  "id": "evt_abc123",
  "type": "work_order.completed",
  "timestamp": "2024-01-15T10:30:00Z",
  "data": {
    "workOrderId": "wo_xyz",
    "completedAt": "2024-01-15T10:30:00Z"
  }
}
```

#### Signing Outgoing Webhooks
```typescript
function signWebhook(payload: string, secret: string): string {
  const timestamp = Math.floor(Date.now() / 1000);
  const signature = crypto
    .createHmac('sha256', secret)
    .update(`${timestamp}.${payload}`)
    .digest('hex');
  
  return `t=${timestamp},v1=${signature}`;
}
```
